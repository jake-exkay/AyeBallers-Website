<?php

	include "../../includes/connect.php";
    include "../../functions/functions.php";

    $top_100 = array('37637353e6b94e3e94ecd9bb46e42af3','31ff34353b4c451aa0a14d1185e17f68','7c59cb3cdcd94346b958750d3818ddb9','82df5a8fa7934e6087d186d8741a1d23','f025c1c7f55a4ea0b8d93f47d17dfe0f','8bb6dd7fb3de43ecaf7e1be7975e7bca','9f16e788457c44fc8c24b90167569420','5ca2314a0fba45cabf4a4a9ff65cec79','b279605ae2b2439b92ab90d0260f56e5','b96f9a8172ae462f8458a7f46afb264c','6ce8dbb747844e3f8dea2f5053300240','328af32299c04996beade25ad4ffff04','d527047841c64ba8a1d9b1307d0315c7','039f7f39d4d84bebb18a23b7b944f34d','f8b79e533de04c86a6bc1ecf579b4cb9','e8e495b5a7784166b330eb548f907f52','b2f94fa711fb4da0a7b8c0288f6efd3b','6f685ff0504348458a61b255cc3b7a42','e9318dcb35374b7ba666e26e8254425d','627e70c9bcbc47c6bd2c9fc2f4e7b9a2','555d01f28d2f486592353cb2f23fb1ef','7ed497aea08f4b798711cbdcf3c2d4c3','96271aeba4bd47fb972088bebb9fee97','4e8f4a8960e3458f86f8cc59ea06d1eb','cb536a596f2543ab8d366ada079fb791','c136b6334e4e4101b511bbe5b403679b','68ebc017179e46fab198211c038bb5e5','a9c95e0c3fb141eebf1f7c8a7919204b','886f642ee3ab44988cb8b18057470bfe','9ac68641d51c40a0896f20b7248d7f32','5de30a2f25134c4197ee34a1ac6a0bf7','016a6ab8359b4dd991e8b5711ce1aaaf','ad46fd81d60c4c9abc8a625f151ae236','f9b3643dfc614666ba8418789c62d6f1','7167ee9767f34d8ab82159875f348ef5','0c99b4fefd4343d9ac8406b141a0f8d7','c94e626be4d440cbae7bf809b006a4a5','cfc3a3949b0843efa34a0a0c34d84133','a2296f23dbf44fcab9f97ad8e80fd8e6','3db8cd6dd55f486c974297a23156fbe6','47d4bf0a89dd4eba9d198c03baf3b980','b0546edb31d743e195d9a492044f2fba','82c8a7e237e3405397c1e7f26d719bc3','8162a3c0ff4a49a8b5adef16fed6e0d8','15061a25d9df460e99c5911b3ceb6356','929da3f3c3fc4a7fa60b6db1d17fadee','807fdb5f8f554a868d1172a90d6baf3d','5409757b87344c0394b10bf966a2d594','c78d2c99954d4f5495d8ea375fff2ad2','fe101e8a30d14137b1101bd22031bf35','029326c6f21a4015a87b015b4b3b9385','0f639d26aa51462f81b3d602604eb204','09bdaa165a1c47658aef1ccd21b9cf45','75f82a304f104f05acfb46c9ffa27bc6','d954bd72bb164d67b188e25616bcac02','61b8a24fef1b4250becdcac342b70fe1','9424483cee334c28b3572d3cc77eb6b6','3f8476c803334a1eaf60c0d4eb4410f5','020d04a179e84d0e8844050282097059','01cbd5dc82bd44ff85e81003bb0fa438','72addd2b87924fbb915094079db52bd7','cf11792af0c6460d9c77968cf2d4bf86','50dbb2ecbf834b6bb3ea990705ba4353','e287a1a898b74dea8e7493717e7185aa','3863e1c33eb342159e45a17f16c0fb4c','a76b01c8a4c04f6ab1ab898f97469224','bd64a5aa13fb462792b3820258dcfdf9','5e5af7934a504d60acad3ab18763dc8c','d910d90845bf4c7fa77db3b4b8705ee3','9a3812b76282481199731b052e66f75c','3c043318784e41ab86de4718faef95c1','f62c91034ee545f6b6777144b00d5c92','355b958941694453a9ab43eada728d1c','180689e255724357bd7f99c194c90526','e01b0f81e1c946e8a6983b3fe6183d6b','6b3053e95f404ca4982b039c8a9729bb','ea733b227673495cac090efd36376ee1','438f82ed71ff43d5aa201982c7353fe4','976aa762ebd04999854b5d548f420d7b','f898afa1538b4101b6255f5401818981','4995579a28f647dfbc03f33fd2aec058','83f44cd9ca9d4712a6bf9e618574f0de','84baea6eb660472eb9b8b20a3f446346','a82811c82b394da8a7767e28d9248a45','d052e63b70ba454d825326ca80b0ee0d','d1d9c04d16474a3cbb2cc1087747a7d2','56d9ab39794444d7ad77d8f3cb20ac78','718c6eaa52434a0e8f3d6c71b2ba6a0f','9a02fb46b9fa445fba8c5db62c9cbf3b','ff7ce8cdfdf64d3e8f91cad7a063ec53','648b236c66684bfbb622d01be7a2d5b3','60fb367459ae4f48812e16b28d8d8afa','3075f56a40ea4f14b1d754fdfc69f7b6','4abdba1d9b274bf7867d5bb4cda287ba','babaee4d60d34732ad3b6ac0775a5a33','82fc95c49afc4b8182b6cefeac42874e','aa6c6113f2e74be6ac14bd0417de66ff','96e0180e19a2494f8559e9cac1887acd','20f1f6cf342b466784acb60ddd9ee38c','43df06bcff994034b0e9bc7507d1f126');

    if (!apiLimitReached($API_KEY)) {
        $last_updated_query = "SELECT * FROM paintball";
        $last_updated_result = $connection->query($last_updated_query);

        if ($last_updated_result->num_rows > 0) {
            while($last_updated_row = $last_updated_result->fetch_assoc()) {
                $last_updated = $last_updated_row['last_updated'];
            }
        }

        $start_date = new DateTime($last_updated);
        $since_start = $start_date->diff(new DateTime(date('Y-m-d H:i:s')));

        if ($since_start->i >= 10 || $since_start->y != 0 || $since_start->m != 0 || $since_start->d != 0 || $since_start->h != 0) {

            $truncate_paintball_query = "DELETE FROM paintball_overall";

            if($truncate_paintball_statement = mysqli_prepare($connection, $truncate_paintball_query)) {
                mysqli_stmt_execute($truncate_paintball_statement);
            } else {
                echo 'Error truncating paintball<br>' . mysqli_error($connection); 
            }

            foreach($top_100 as $uuid) {
                $player_url = file_get_contents("https://api.hypixel.net/player?key=".$API_KEY."&uuid=".$uuid);
                $player_decoded_url = json_decode($player_url);

                // Get real name
                $mojang_url = file_get_contents("https://api.mojang.com/user/profiles/".$uuid."/names");
                $mojang_decoded_url = json_decode($mojang_url, true);
                $real_name = array_pop($mojang_decoded_url);
                $name = $real_name['name'];

                // GENERAL VARS
                $rank = "Error";
                $mvp_plus_colour = "RED";

                // PAINTBALL VARS
                $kills_paintball = 0;
                $wins_paintball = 0;
                $coins_paintball = 0;
                $shots_fired_paintball = 0;
                $deaths_paintball = 0;
                $godfather_paintball = 0;
                $endurance_paintball = 0;
                $superluck_paintball = 0;
                $fortune_paintball = 0;
                $headstart_paintball = 0;
                $adrenaline_paintball = 0;
                $forcefield_time_paintball = 0;
                $killstreaks_paintball = 0;
                $transfusion_paintball = 0;
                $hat_paintball = 0;

                // GENERAL CHECKS
                $rank = !empty($player_decoded_url->player->packageRank) ? $player_decoded_url->player->packageRank : 'Error';
                $mvp_plus_colour = !empty($player_decoded_url->player->rankPlusColor) ? $player_decoded_url->player->rankPlusColor : 'Error';

                // PAINTBALL CHECKS
                $kills_paintball = !empty($player_decoded_url->player->stats->Paintball->kills) ? $player_decoded_url->player->stats->Paintball->kills : 0;
                $wins_paintball = !empty($player_decoded_url->player->stats->Paintball->wins) ? $player_decoded_url->player->stats->Paintball->wins : 0;
        		$coins_paintball = !empty($player_decoded_url->player->stats->Paintball->coins) ? $player_decoded_url->player->stats->Paintball->coins : 0;
                $shots_fired_paintball = !empty($player_decoded_url->player->stats->Paintball->shots_fired) ? $player_decoded_url->player->stats->Paintball->shots_fired : 0;
                $deaths_paintball = !empty($player_decoded_url->player->stats->Paintball->deaths) ? $player_decoded_url->player->stats->Paintball->deaths : 0;
        		$godfather_paintball = !empty($player_decoded_url->player->stats->Paintball->godfather) ? $player_decoded_url->player->stats->Paintball->godfather : 0;
                $endurance_paintball = !empty($player_decoded_url->player->stats->Paintball->endurance) ? $player_decoded_url->player->stats->Paintball->endurance : 0;
        		$superluck_paintball = !empty($player_decoded_url->player->stats->Paintball->superluck) ? $player_decoded_url->player->stats->Paintball->superluck : 0;
                $fortune_paintball = !empty($player_decoded_url->player->stats->Paintball->fortune) ? $player_decoded_url->player->stats->Paintball->fortune : 0;
                $headstart_paintball = !empty($player_decoded_url->player->stats->Paintball->headstart) ? $player_decoded_url->player->stats->Paintball->headstart : 0;
                $adrenaline_paintball = !empty($player_decoded_url->player->stats->Paintball->adrenaline) ? $player_decoded_url->player->stats->Paintball->adrenaline : 0;
                $forcefield_time_paintball = !empty($player_decoded_url->player->stats->Paintball->forcefieldTime) ? $player_decoded_url->player->stats->Paintball->forcefieldTime : 0;
                $killstreaks_paintball = !empty($player_decoded_url->player->stats->Paintball->killstreaks) ? $player_decoded_url->player->stats->Paintball->killstreaks : 0;
                $transfusion_paintball = !empty($player_decoded_url->player->stats->Paintball->transfusion) ? $player_decoded_url->player->stats->Paintball->transfusion : 0;
                $hat_paintball = !empty($player_decoded_url->player->stats->Paintball->hat) ? $player_decoded_url->player->stats->Paintball->hat : "no hat";

                // Format paintball hats
                if ($hat_paintball == 'normal_hat') {
                    $hat_paintball = 'Normal Hat';
                } elseif ($hat_paintball == 'trololol_hat') {
                    $hat_paintball = 'Trololol Hat';
                } elseif ($hat_paintball == 'vip_hypixel_hat') {
                    $hat_paintball = 'Hypixel';
                } elseif ($hat_paintball == 'vip_rezzus_hat') {
                    $hat_paintball = 'Rezzus';
                } elseif ($hat_paintball == 'vip_paintballkitty_hat') {
                    $hat_paintball = 'PaintballKitty';
                } elseif ($hat_paintball == 'drunk_hat') {
                    $hat_paintball = 'Drunk Hat';
                } elseif ($hat_paintball == 'vip_noxyd_hat') {
                    $hat_paintball = 'NoxyD';
                } elseif ($hat_paintball == 'vip_ghost_hat') {
                    $hat_paintball = 'Ghost Hat';
                } elseif ($hat_paintball == 'shaky_hat') {
                    $hat_paintball = 'Shaky Hat';
                } elseif ($hat_paintball == 'speed_hat') {
                    $hat_paintball = 'Speed Hat';
                } elseif ($hat_paintball == 'vip_codename_b_hat') {
                    $hat_paintball = 'Codename B';
                } elseif ($hat_paintball == 'tnt_hat') {
                    $hat_paintball = 'TNT Hat';
                } elseif ($hat_paintball == 'snow_hat') {
                    $hat_paintball = 'Snow Hat';
                } elseif ($hat_paintball == 'hard_hat') {
                    $hat_paintball = 'Hard Hat';
                } elseif ($hat_paintball == 'ender_hat') {
                    $hat_paintball = 'Ender Hat';
                } elseif ($hat_paintball == 'hat_of_darkness') {
                    $hat_paintball = 'Darkness Hat';
                } elseif ($hat_paintball == 'squid_hat') {
                    $hat_paintball = 'Squid Hat';
                } elseif ($hat_paintball == 'spider_hat') {
                    $hat_paintball = 'Spider Hat';
                } elseif ($hat_paintball == 'vip_kevinkool_hat') {
                    $hat_paintball = 'Kevinkool';
                } elseif ($hat_paintball == 'vip_neonmaster_hat') {
                    $hat_paintball = 'Neonmaster';
                } elseif ($hat_paintball == 'vip_agentk_hat') {
                    $hat_paintball = 'AgentK';
                } else {
                    $hat_paintball = 'No Hat';
                }

                $fortune_paintball += 1;
                $endurance_paintball += 1;
                $godfather_paintball += 1;
                $superluck_paintball += 1;
                $adrenaline_paintball += 1;
                $headstart_paintball += 1;
                $transfusion_paintball += 1;

                // PAINTBALL INSERT
                $query_paintball = "INSERT INTO paintball_overall (UUID, kills, wins, coins, shots_fired, deaths, godfather, endurance, superluck, fortune, headstart, adrenaline, forcefield_time, killstreaks, transfusion, hat, rank, mvp_plus_colour, last_updated, name)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, now(), ?)";

                if($statement_paintball = mysqli_prepare($connection, $query_paintball)) {
                    mysqli_stmt_bind_param($statement_paintball, "siiiiiiiiiiisiissss", $uuid, $kills_paintball, $wins_paintball, $coins_paintball, $shots_fired_paintball, $deaths_paintball, $godfather_paintball, $endurance_paintball, $superluck_paintball, $fortune_paintball, $headstart_paintball, $adrenaline_paintball, $forcefield_time_paintball, $killstreaks_paintball, $transfusion_paintball, $hat_paintball, $rank, $mvp_plus_colour, $name);
                    mysqli_stmt_execute($statement_paintball);
                } else {
                    echo '<b>[PAINTBALL] '.$name.' </b>An Error Occured!<br>'; 
                }

                header("Refresh:0.01; url=/var/www/html/leaderboard/classic/overall/paintball.php");
            }
        } else {
            echo "Database was updated less than an 10 minutes ago. Redirecting.";
            header("Refresh:2; url=/var/www/html/leaderboard/classic/overall/paintball.php");
        }
    } else {
        echo "Error: Too many concurrent API requests, please try again in a minute.";
        header("Refresh:2; url=/var/www/html/leaderboard/classic/overall/paintball.php");
    }

    $connection->close();

?>